---
title: "Plots for LCM paired paper"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

library(tidyverse)
library(sf)
library(scales)
library(gridExtra)
```

# Run the model
First step is to run the model and ensure that figures will be created from the correct results. 

To generate all LCM paper figures: either click Knit or Run > Run All

Takes ~10 min to run all models and generate figs. 


```{r run lcm, include=FALSE, eval = TRUE}

# Setup run params
run_stochastic_eggtofry <- 'no'
run_single_action <- 'no'
sensitivity.mode <- 'no'
branch <- system(command = "git rev-parse --abbrev-ref HEAD", intern = TRUE)

get_os <- function(){
  sysinf <- Sys.info()
  if (!is.null(sysinf)){
    os <- sysinf['sysname']
    if (os == 'Darwin')
      os <- "osx"
  } else { ## mystery machine
    os <- .Platform$OS.type
    if (grepl("^darwin", R.version$os))
      os <- "osx"
    if (grepl("linux-gnu", R.version$os))
      os <- "linux"
  }
  tolower(os)
}
os <- get_os()

# Load packages ----

global.pkgs <- c('tidyverse', 'magrittr', 'lubridate', 'zoo')
lapply(global.pkgs, require, character.only = TRUE)

# Delete existing outputs folder
unlink("outputs", recursive = TRUE) # WARNING -- If running all species the entire outptus 

# Run the model
for (s in c('coho', 'spring_chinook', 'fall_chinook', 'steelhead', 'chum')) {
  fishtype <- s
  source("hab/R_files/0-Run_Habitat_Model.R")
  source("lcm/LCM.sim.R")
  print(paste0("finished ", s))
}

```

# Read in data

First step is to read in the data. **There are various versions of the model, so ensure that this document is pointing at the version you want.** Spawner results from model runs can be found on the shared drive at the address below, or regenerated by running the correct version of the model.

The default behavior is to 


Location of spatial model outputs: `//nwcfile/FE/watershed/Chehalis/Data/10-Habitat data layers/SpatialModel_Archive/`
Location of spawner outputs: `//nwcfile/FE/watershed/Chehalis/Data/11-Model Outputs/`

Note: as we are working from home, I am working from a version of GIS files on my local machine. 

```{r}

# Habitat scenario and LCM results
# results <- '//nwcfile/FE/watershed/Chehalis/Data/11-Model Outputs/V14_pr226_dev/'
results <- 'outputs'



# Spatial data
# Data is either local or on shared drive

if (dir.exists("C:/01_Projects/Chehalis/Spatial_Model/spatial_model_gitlab")) {
  
  # Colin's local files
  
  gdb_in <- 'C:/01_Projects/Chehalis/Spatial_Model/spatial_model_gitlab/Inputs.gdb'
  gdb_out <- 'C:/01_Projects/Chehalis/Spatial_Model/spatial_model_gitlab/Outputs.gdb'
  
} else {
  # Access files on the network
  gdb_in <- '//nwcfile/FE/watershed/Chehalis/Data/10-Habitat data layers/SpatialModel_Archive/20190604/Inputs.gdb'
  gdb_out <- '//nwcfile/FE/watershed/Chehalis/Data/10-Habitat data layers/SpatialModel_Archive/20190604/Outputs.gdb'
  
}



# Subbasin names and EDRs
Subbasin_names <- read.csv('lcm/data/Subbasin_names.csv') %>%
  mutate(EcoRegion = ifelse(str_detect(Subbasin, 'Estuary'),'Estuary', as.character(EcoRegion)))

# Plot colors and labels
plot.params <- read.csv('lcm/data/scenarios.csv') %>% 
  select(scenario, scenario.label, color) %>%
  mutate_if(is.factor, as.character) %>%
  rowid_to_column()
```


Read in the necessary GIS layers
```{r echo = TRUE, message=FALSE}

# Flowline (which has spawning distributions)
fl <- st_read(gdb_out, 'flowline')

# Subbasin layer
sub <- st_read(gdb_in, 'NOAA_subbasins_w_fp') %>% st_geometry()
```

# Figures

## Figure 1 - Location Map
Created in ArcMap




## Figure 2 - Map of species ranges



Create a 'long' version of the flowline, where the 5 species columns are colapsed down to 2: 'species' and 'presence' (yes/no). Also create the 'rearing distribution' which is simply the spawning distribution plus the mainstem.

```{r}
fl_long <- fl %>%
  select(noaaid, noaa_sub_num,cohospawn:steelspawn, wet_width) %>%
  gather(species, presence, cohospawn:steelspawn) %>%
  mutate(species = case_when(
    species == 'cohospawn'  ~ 'Coho',
    species == 'fallspawn'  ~ 'Fall Chinook',
    species == 'sprspawn'   ~ 'Spring Chinook',
    species == 'steelspawn' ~ 'Steelhead',
    species == 'chumspawn'  ~ 'Chum'
  )) %>%
  filter(species != 'Chum') %>%
  mutate(distribution = case_when(
    (noaa_sub_num %in% 52:63)  & presence == 'No'  ~ 'Rearing and outmigration',
    (noaa_sub_num %in% 52:63)  & presence == 'Yes' ~ 'Spawning and rearing',
    !(noaa_sub_num %in% 52:63) & presence == 'Yes' ~ 'Spawning and rearing',
    !(noaa_sub_num %in% 52:63) & presence == 'No'  ~ 'No'),
    width_bin = cut(wet_width, c(-Inf, 5, 10, 20, 30, 50, Inf))) %>%
  filter(!is.na(width_bin))
```


Plot it. 

```{r, out.width = 6, out.height=7}
# color blind friendly palette http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/

p2 <- ggplot() +
  theme_void() +
  geom_sf(data = st_union(sub), size = .2, color = 'grey20', fill = NA) +
  geom_sf(data = fl_long, aes(color = distribution, size = width_bin), show.legend = 'line') +
  facet_wrap(~species) +
  scale_color_manual(breaks = c('Spawning and rearing', 'Rearing and outmigration'), 
                     values = c('gray70', "#D55E00", "#0072B2")) + 
  scale_size_manual(values = seq(0.1, 0.6, length.out = 6), guide = FALSE) +
  theme(legend.position = "bottom",
        strip.text.x = element_text(margin = margin(0,0,.1,0, "cm"))) +
  labs(color = NULL)


ggsave("docs/companion_papers/lcm_fig_2_distributions.tiff", 
       p2, 
       width = 3.5, 
       height = 4.5, 
       dpi = 500, 
       compression = "lzw")
```






## Figure 3 - Diagnostic scenario bar charts

4/29/2020 NOTE: This will need to be recreated once we get outputs with the combined LR scenario. 

First read the basinwide results for all species. 

```{r}
# List all basinwide results files
basinwide_paths <- list.files(results,
                              recursive = TRUE,
                              pattern = 'abundance_basinwide',
                              full.names = TRUE)

# Create list of species to attach to each file
spp <- basinwide_paths %>%
  dirname %>%
  dirname %>%
  basename()

basinwide_df <- basinwide_paths %>%
  map_dfr(.id = 'species', read.csv) %>%
  select(-X) %>%
  mutate(species = spp[as.numeric(species)],
         species = case_when(
           species == 'coho'  ~ 'Coho',
           species == 'fall_chinook'  ~ 'Fall Chinook',
           species == 'spring_chinook'   ~ 'Spring Chinook',
           species == 'steelhead' ~ 'Steelhead',
           species == 'chum'  ~ 'Chum'
         )) 
```


Now we can join the basinwide spawner data and the plot param data. This is the dataframe used to make the plot. 
```{r}
# Join data and plot parameters, create labels for percent change
df_fig3 <- basinwide_df %>%
  left_join(plot.params) %>%
  filter(species != 'Chum',
         str_detect(scenario, 'ASRP|FP', negate =  TRUE)) %>%
  rename(n = basinwide_spawners) %>%
  group_by(species) %>%
  mutate(curr = n[scenario == 'Current'],
         prcnt.change = (n - curr)/curr,
         prcnt.change = ifelse(prcnt.change >= 0,
                               paste0('+', scales::label_percent(1)(prcnt.change)),
                               scales::label_percent(1)(prcnt.change))) %>%
  arrange(rowid) %>%
  mutate(scenario = case_when(
    scenario == 'LR' ~ "Large River", 
    TRUE ~ str_replace(scenario, '\\.', ' ') %>% tools::toTitleCase(.)
  ))
```


Make the plot. 
```{r out.width = 4, out.height=3}
# Plot it
ggplot(df_fig3) +
  cowplot::theme_half_open() +
  facet_wrap(~species, scales = 'free_y') +
  geom_bar(aes(reorder(scenario, rowid), 
               n, 
               fill = color),
           color = 'black',
           stat = "identity") +
  geom_bar(aes(scenario, 
               curr),
           color = 'black',
           stat = "summary", 
           fun = "mean",
           fill = 'grey',
           alpha = .6) +
  geom_text(data = df_fig3 %>% filter(scenario != 'Current'), 
            aes(x = scenario, 
                y = n, 
                label = prcnt.change),
            vjust = -0.3,
            size = 2.5) +
  scale_fill_identity(guide = F) +
  scale_y_continuous(labels = comma, 
                     expand = c(0, 0,.1,0)) +
  labs(x = NULL,
       y = paste0('Spawners')) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        text = element_text(size = 10),
        strip.background = element_blank(),
        axis.title.y = element_text(size = 16),
        strip.text = element_text(size = 12),
        axis.ticks.x = element_line())


ggsave("docs/companion_papers/lcm_fig_3_basinwide_bars.tiff", width = 6.5, height = 4, dpi = 300, compression = "lzw")
```





## Figure 4 - Restore one EDR at a time

First gather up the data
```{r}
# List all results by EDR files
edr_paths <- list.files(results,
                        recursive = TRUE,
                        pattern = 'abundance_by_EDR',
                        full.names = TRUE)

# Create list of species to attach to each file
spp <- edr_paths %>%
  dirname %>%
  dirname %>%
  basename()


edr_df <- edr_paths %>%
  map_dfr(.id = 'species', read.csv) %>%
  select(-X) %>%
  mutate(species = spp[as.numeric(species)]) %>%
  group_by(species, EcoRegion) %>%
  mutate(current = basinwide_spawners[scenario == 'Current'],
         diff = basinwide_spawners - current,
         diff_perc = diff/current,
         diff_bin = cut(diff, 
                        c(-Inf, 200, 5000, 10000, Inf),
                        c('< 200', '200 - 5,000', '5,000 - 10,000', '> 10,000'))) %>%
  ungroup %>%
  mutate(presence = case_when( # create NAs for spring chinook basins
    str_detect(species, 'spring') & 
      str_detect(EcoRegion, 'Mainstem|Cascade|Willapa', negate = TRUE) ~ 'no fish'),
    diff_prcnt2 = ifelse(!is.na(presence), NA,
                         ifelse(is.na(diff_perc), 0, 
                                ifelse(diff_perc > 1, 1, diff_perc))),
    diff2 = ifelse(!is.na(presence), NA,
                   ifelse(is.na(diff), 0, diff)),
    diff_prcnt2_bin = cut(diff_prcnt2, 
                        c(-Inf, 0.05, .1, .25, .50, Inf),
                        c('< 5%', '5 - 10%', '10-25%', '25 - 50%', '> 50%')),
    species2 = case_when(
           species == 'coho'  ~ 'Coho',
           species == 'fall_chinook'  ~ 'Fall Chinook',
           species == 'spring_chinook'   ~ 'Spring Chinook',
           species == 'steelhead' ~ 'Steelhead',
           species == 'chum'  ~ 'Chum')
  )

```



```{r}
# Union subbasins into EDRs
sub_edr <- st_read(dsn = gdb_in, layer = 'NOAA_subbasins_w_fp') %>%
  rename(Subbasin_num = noaa_sub_num) %>%
  left_join(Subbasin_names) %>%
  group_by(EcoRegion) %>%
  summarize(Area_km2 = sum(Area_km2)) %>%
  ungroup
```

Join the spawner data to the new EDR layer. Also join the `plot.param` data
```{r}
sub_plot_diag <- sub_edr %>%
  left_join(edr_df) %>%
  filter(str_detect(EcoRegion, 'Estuary|Upper Sk', negate = TRUE),
         str_detect(scenario, 'Current|Historical|ASRP|FP.w', negate = TRUE),
         species != 'chum') %>%
  left_join(plot.params)

```

Figure 4 with the 'standard' results of change in EDR as a percent of the EDR under current conditions. This matches the text of the draft paper. 

```{r}

edr_df2 <- edr_df %>%
  filter(str_detect(EcoRegion, 'Estuary|Upper Sk', negate = TRUE),
         str_detect(scenario, 'Current|Historical|ASRP|FP.w', negate = TRUE),
         species != 'chum') %>%
  mutate(diff_perc2 = ifelse(diff_perc > 1, 1, 
                             ifelse(diff_perc < 0, 0, 
                                    diff_perc)),
         diff_perc_bin = cut(diff_perc,
                             c(-Inf, seq(.1,.9, .1), Inf)))

sub_plot <- sub_edr %>% #st_drop_geometry()
  #left_join(one_edr_df) %>%
  left_join(edr_df2) %>%
  filter(!is.na(scenario),
         !is.na(species2)) %>%
  mutate(scenario = case_when(
    scenario == 'LR' ~ "Large River",
    TRUE ~ str_replace(scenario, '\\.', ' ') %>% tools::toTitleCase(.)
  ))


p_prcnt <- ggplot() +
  theme_void() +
  geom_sf(data = sub_plot,
          aes(fill = diff_perc2),
          color = 'black',
          lwd = 0.01) +
  geom_sf(data = filter(sub_edr, str_detect(EcoRegion, 'Estuary|Upper Sk')),
          fill = 'gray50',
          color = 'black',
          lwd = 0.01) +
  facet_grid(scenario ~ species2, switch = 'y') +
  scale_fill_viridis_c(na.value = 'gray50',
                       labels = c('0%', '25%', '50%', '75%', '>100%')) +
  theme(panel.spacing = unit(-0.2, 'cm'),
        strip.text.y.left = element_text(angle = 0),
        strip.text.x = element_text(margin = margin(0,0,.2,0, "cm"))) +
  labs(fill = 'Change in\nspawners')

ggsave('docs/companion_papers/lcm_fig_4_restore_per_EDRprcnt_test.tiff',
       p_prcnt,
       width = 5.5,
       height = 6.5,
       dpi = 500,
       compression = "lzw")
```




## Figure 5 and 7 - Absolute and percent change

Figure 7 is floodplain and Figure 5 is barriers.


```{r}
s <- sub_plot_diag %>% pull(scenario) %>% unique %>% str_subset('Floodplain|Barriers')

lapply(s, function(x) {
  df <- sub_plot_diag %>%
    filter(scenario == x)
  
  if (x == 'Barriers') {
    my_breaks <- c(0, .10, .20, .30, .4, .5)
    my_labs <- paste0(c(0, 10, 20, 30, 40, 50), '%')
  } else {
    my_breaks <- c(0, .25, .50, .75, 1)
    my_labs <- paste0(c(0, 25, 50, 75, '>100'), '%')
  }
  
  p1 <- ggplot() +
    theme_void() +
    geom_sf(data = sub_plot_diag %>% filter(scenario == x), 
            aes(fill = diff2),
            color = 'black',
            lwd = 0.01) +
    geom_sf(data = filter(sub_edr, str_detect(EcoRegion, 'Estuary|Upper Sk')),
            fill = 'gray50',
            color = 'black',
            lwd = 0.01) +
    facet_wrap(~species2, nrow = 1) +
    scale_fill_viridis_c(
      label = scales::label_comma()) +
    labs(fill = NULL,
         tag = "A") +
    guides(fill = guide_colorbar(barwidth = .75,
                                 barheight = 4,
                                 label.theme = element_text(size = 8))) +
    theme(strip.text.x = element_text(margin = margin(0,0,.1,0, "cm")),
          plot.tag.position = c(0.02, .9))
  
  p2 <- ggplot() +
    theme_void() +
    geom_sf(data = sub_plot_diag %>% filter(scenario == x), 
            aes(fill = diff_prcnt2),
            color = 'black',
            lwd = 0.01) +
    geom_sf(data = filter(sub_edr, str_detect(EcoRegion, 'Estuary|Upper Sk')),
            fill = 'gray50',
            color = 'black',
            lwd = 0.01) +
    facet_wrap(~species2, nrow = 1) +
    scale_fill_viridis_c(
      labels = my_labs,
      breaks = my_breaks) +
    labs(fill = NULL,
         tag = "B") +
    theme(strip.text = element_blank(),
          plot.margin = margin(t = -2, unit = "cm"),
          legend.justification = 'left',
          plot.tag.position = c(0.02, .9)) +
    guides(fill = guide_colorbar(barwidth = .75,
                                 barheight = 4,
                                 label.theme = element_text(size = 8)))
    
  
  
  p_grid2 <- cowplot::plot_grid(p1 = p1,
                                p2 = p2,
                                nrow = 2,
                                #labels = c('A', 'B'),
                                align = 'v')
                                #label_size = 12,
                                # label_x = .85, 
                                # label_y = .9,
                                #rel_heights = c(1, 1.5))
  
  if (x == 'Barriers') {
    fig_num <- 'docs/companion_papers/lcm_fig_5'
  } else {
   fig_num <- 'docs/companion_papers/lcm_fig_7'
  }
  
  cowplot::save_plot(paste0(fig_num,'_viridis_',x,'.tiff'), 
                     p_grid2, 
                     base_height = 3, 
                     base_width = 5, 
                     dpi = 300, 
                     compression = "lzw")
  
  
})
```





## Figure 6 - BIP

```{r}
bip <- read.csv('hab/Inputs/spatial_model_outputs/flowline_20200512.csv') %>%
   mutate(score_slope = 
            case_when(
              slope < .01 ~ 4,
              between(slope, .01, .02) ~ 3,
              between(slope, .02, .04) ~ 2,
              between(slope, .04, .06) ~ 1,
              between(slope, .06, .10) ~ 0.5,
              slope > .10 ~ 0
            ),
          score_width = case_when(
            BF_width < 7 ~ 4,
            between(BF_width, 7, 10) ~ 3,
            between(BF_width, 10, 18) ~ 2,
            between(BF_width, 18, 24) ~ 1,
            BF_width > 24 ~ 0),
          score = score_slope + score_width,
          score_bin = case_when(
            score >= 7 ~ 'High',
            between(score, 5, 7) ~ 'Medium',
            between(score, 4, 5) ~ 'Low',
            score < 4 ~ 'No BIP'
          ),
          score_bin = factor(score_bin, levels = rev(c('No BIP', 'Low', 'Medium', 'High')))) %>%
  select(noaaid, score_bin)


fl_bip <- left_join(fl, bip) %>%
  mutate(width_bin = cut(wet_width, c(-Inf, 5, 10, 20, 30, 50, Inf))) %>%
  filter(!is.na(width_bin),
         !is.na(score_bin))
```


```{r}
sub_edr <- st_read(gdb_in, 'NOAA_subbasins_w_fp') %>% 
  left_join(Subbasin_names %>% rename(noaa_sub_num = Subbasin_num)) %>%
  group_by(EcoRegion) %>%
  summarize
```


```{r}
f_bip <- ggplot() +
  theme_void() +
  geom_sf(data = sub_edr, size = .5, color = 'grey20', fill = NA) + 
  geom_sf(data = fl_bip, aes(color = score_bin, size = width_bin)) +
  scale_size_manual(values = seq(0.3, .8, length.out = 6), guide = FALSE) +
  scale_color_brewer(palette = 'Spectral', direction = -1) +
  labs(color = 'BIP Score') +
  theme(legend.position = c(.7,.8))

ggsave('docs/companion_papers/lcm_fig_6_bip.tiff',
       f_bip,
       width = 4,
       height = 4,
       dpi = 500,
       compression = "lzw")

```














