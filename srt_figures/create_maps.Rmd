---
title: "Figs"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)
library(scales)
```

# Read in data

First step is to read in the data. **This analysis needs to use V13.1** 

This branch should be a child of V13.1 without any other merges from dev. 

```{r}


# Habitat scenario and LCM results
results <- 'outputs_v13.1_w_Hist_future/'



# Spatial data

# Access files on the network
gdb_in <- '//nwcfile/FE/watershed/Chehalis/Data/10-Habitat data layers/SpatialModel_Archive/20200512/Inputs.gdb'
# gdb_out <- '//nwcfile/FE/watershed/Chehalis/Data/10-Habitat data layers/SpatialModel_Archive/20200512/Outputs.gdb'

# Files on Colin's local machine
# gdb_in <- 'C:/01_Projects/Chehalis/Spatial_Model/spatial_model_gitlab/Inputs.gdb'


# Subbasin names and EDRs
Subbasin_names <- read.csv('../lcm/data/Subbasin_names.csv') %>%
  mutate(EcoRegion = ifelse(str_detect(Subbasin, 'Estuary'),
                            'Estuary', 
                            as.character(EcoRegion)))

# Plot colors and labels
plot.params <- read.csv('../lcm/data/scenarios.csv') %>% 
  select(scenario, scenario.label, color) %>%
  mutate_if(is.factor, as.character) %>%
  rowid_to_column()


# Read in subbasin layer
sub_shp <- st_read(dsn = gdb_in, layer = 'NOAA_subbasins_w_fp') %>%
  rename(Subbasin_num = noaa_sub_num) %>%
  left_join(Subbasin_names)


```


# Section 1 figures


## Spawner results by Subbasin

Four panel figures for abundance change using one-subbasin at a time. Use units of spawners/km to normalize by basin size. One figure for each diagnostic scenario except the large river scenario.

https://trello.com/c/YZ5zt993



First gather up the data
```{r}
# Calculate length of river in each subbasin for each species
fl_len <- '../hab/Inputs/spatial_model_outputs/flowline_20200512.csv' %>%
  read.csv %>%
  select(noaaid, noaa_sub_num,cohospawn:steelspawn, Shape_Length) %>%
  pivot_longer(cohospawn:steelspawn, 
               names_to = 'species', 
               values_to = 'presence') %>%
  filter(presence == 'Yes') %>%
  distinct(noaaid, noaa_sub_num, Shape_Length) %>%
  group_by(noaa_sub_num) %>%
  summarize(length_km = sum(Shape_Length) / 1e3) %>%
  ungroup %>%
  rename(Subbasin_num = noaa_sub_num) %>%
  left_join(Subbasin_names) %>%
  filter(!is.na(length_km))

fl_presence <- '../hab/Inputs/spatial_model_outputs/flowline_20200512.csv' %>%
  read.csv %>%
  select(noaaid, noaa_sub_num,cohospawn:steelspawn, Shape_Length) %>%
  pivot_longer(cohospawn:steelspawn, 
               names_to = 'species', 
               values_to = 'presence') %>%
  filter(presence == 'Yes') %>%
  distinct(species, noaa_sub_num) %>%
   mutate(species = case_when(
    species == 'cohospawn'  ~ 'coho',
    species == 'fallspawn'  ~ 'fall_chinook',
    species == 'sprspawn'   ~ 'spring_chinook',
    species == 'steelspawn' ~ 'steelhead',
    species == 'chumspawn'  ~ 'chum'
  )) %>%
  rename(Subbasin_num = noaa_sub_num) %>%
  filter(!(species == 'steelhead' & Subbasin_num == 63),
         !(species == 'fall_chinook' & Subbasin_num == 63))

# List all results by subbasin files
sub_paths <- list.files(results,
                        recursive = TRUE,
                        pattern = 'abundance_by_subbasin.csv',
                        full.names = TRUE)

# Create list of species to attach to each file
spp <- sub_paths %>%
  dirname %>%
  dirname %>%
  basename()




sub_df <- sub_paths %>%
  map_dfr(.id = 'species', read.csv) %>%
  select(-X) %>%
  mutate(species = spp[as.numeric(species)]) %>%
  select(species:spawners, Pn, Cn) %>%
  rename(Subbasin = natal.basin) %>%
  left_join(fl_len) %>%
  right_join(fl_presence) %>%
  group_by(species) %>%
  mutate(current_basinwide = sum(spawners[scenario == 'Current'])) %>%
  group_by(species, Subbasin) %>%
  mutate(current = spawners[scenario == 'Current'],
         nat_potential = ifelse(str_detect(scenario, '.2040', negate = FALSE) == T,
                                spawners[scenario  == 'Historical.2040'],
                                ifelse(str_detect(scenario, '.2080', negate = F) == T,
                                       spawners[scenario == 'Historical.2080'],
                                       spawners[scenario == 'Historical'])),
         diff = spawners - current,
         diff_asrp = nat_potential - spawners,
         diff_prcnt = (diff/current_basinwide),
         #diff_prcnt = ifelse(diff_prcnt > 0.25, 0.25, diff_prcnt),
         diff_prcnt_km = ifelse(is.na(length_km), 
                              NA,
                              ifelse(diff == 0,
                                     0,
                                     (diff_prcnt/length_km))),
         diff_prcnt_km2 = ifelse(diff_prcnt_km > 0.001,
                               0.001,
                               ifelse(diff_prcnt_km <= 0,
                                      0,
                                      diff_prcnt_km)),
         diff_per_km = ifelse(is.na(length_km),
                              NA,
                              ifelse(diff == 0,
                                     0,
                                     diff/length_km)),
         diff_per_km_asrp = ifelse(is.na(length_km),
                                   NA,
                                   ifelse(diff == 0,
                                          0,
                                          diff_asrp / length_km)),
         diff_per_km2 = ifelse(diff_per_km > 10,
                               10,
                               ifelse(diff_per_km <= 0,
                                      0,
                                      diff_per_km)),
         diff_pn = Pn - Pn[scenario == 'Current'])

```


Join the spawner data to the subbasin layer. Also join the `plot.param` data so we can get colors for each diagnostic scenario. 

```{r}
sub_plot <- sub_shp %>%
  full_join(sub_df) %>%
  filter(str_detect(EcoRegion, 'Estuary|Upper Sk', negate = TRUE),
         str_detect(scenario, 'Current|LR', negate = TRUE),
         species != 'chum') %>%
  left_join(plot.params) %>%
  mutate(species2 = case_when(
    species == 'coho'  ~ 'Coho',
    species == 'fall_chinook'  ~ 'Fall Chinook',
    species == 'spring_chinook'   ~ 'Spring Chinook',
    species == 'steelhead' ~ 'Steelhead',
    species == 'chum'  ~ 'Chum'))
```

### Percent diff
```{r}

plot_prcnt_change <- function(s) {
  shp_plt <- sub_plot %>% filter(scenario == s)

  p <- ggplot() +
    theme_void() +
    geom_sf(data = sub_shp,
            fill = 'gray50',
            color = 'black',
            lwd = 0.01) +
    geom_sf(data = shp_plt,
            aes(fill = diff_prcnt), # * 1e3),
            color = 'black',
            lwd = 0.01) +
    facet_wrap(~species2) +
    scale_fill_gradient2(low = 'white',
                         high = muted(shp_plt$color %>% unique),
                         mid = shp_plt$color %>% unique,
                         midpoint = .125,
                         limits = c(0, 0.25),
                         labels = label_percent(accuracy = 1L)) +
    theme(panel.spacing = unit(-0.2, 'cm'),
          strip.text.x = element_text(margin = margin(0,0,0.05,0, "cm"))) +
    labs(fill = 'Change in\nbasinwide\nspawners',
         title = str_replace(s, '\\.', ' '))

  folder_name <- 'Figs_Section1_prcnt_diff'

  if (dir.exists(folder_name) == F) {dir.create(folder_name)}

  ggsave(file.path(folder_name,paste0('2_',s,'.tiff')),
         p,
         height = 4,
         width = 6.5,
         dpi = 500,
         compression = "lzw")

}


plt_scenarios <- sub_plot %>%
  filter(str_detect(scenario, 'ASRP|Historical|FP', negate = TRUE)) %>%
  pull(scenario) %>%
  unique



lapply(plt_scenarios, plot_prcnt_change)
```


### Spawners per km
```{r}

plot_spawners_per_km <- function(s) {
  shp_plt <- sub_plot %>% filter(scenario == s)
  
  p <- ggplot() +
    theme_void() +
    geom_sf(data = sub_shp,
            fill = 'gray50',
            color = 'black',
            lwd = 0.01) +
    geom_sf(data = shp_plt, 
            aes(fill = diff_per_km2), # * 1e3),
            color = 'black',
            lwd = 0.01) +
    facet_wrap(~species2) +
    scale_fill_gradient2(low = 'white', 
                         high = muted(shp_plt$color %>% unique),
                         mid = shp_plt$color %>% unique,
                         midpoint = 5,
                         breaks = c(0, 2.5 ,5, 7.5, 10),
                         labels = c('0', '2.5', '5', '7.5', '>10')
                         ) +
    # scale_fill_viridis_c(#label = percent, 
      #drop = FALSE
      # na.value = 'gray50') +
    theme(panel.spacing = unit(-0.2, 'cm'),
          strip.text.y = element_text(angle = -90)) +
    labs(fill = 'Change in\nspawners\nper Km',
         title = str_replace(s, '\\.', ' '))
  
  folder_name <- 'Figs_Section1_spawners_per_km'
  
  if (dir.exists(folder_name) == F) {dir.create(folder_name)}
  
  ggsave(file.path(folder_name,paste0('1_',s,'.tiff')), 
         p,
         height = 4,
         width = 6.5,
         dpi = 500,
         compression = "lzw")
  
}


plt_scenarios <- sub_plot %>% 
  filter(str_detect(scenario, 'ASRP|Historical|FP', negate = TRUE)) %>%
  pull(scenario) %>%
  unique
  


lapply(plt_scenarios, plot_spawners_per_km)
```

### Stacked plots by species

```{r}
#s <- 'Barriers'

plot_stacked <- function(s) {
  shp_plt <- sub_plot %>% filter(scenario == s)

  p1 <- ggplot() +
    theme_void() +
    geom_sf(data = sub_shp,
            fill = 'gray50',
            color = 'black',
            lwd = 0.01) +
    geom_sf(data = shp_plt, 
            aes(fill = diff_per_km2), # * 1e3),
            color = 'black',
            lwd = 0.01) +
    facet_wrap(~species2, nrow = 1) +
    scale_fill_gradient2(low = 'white', 
                         high = muted(shp_plt$color %>% unique),
                         mid = shp_plt$color %>% unique,
                         midpoint = 5,
                         breaks = c(0, 2.5 ,5, 7.5, 10),
                         labels = c('0', '2.5', '5', '7.5', '>10')
                         ) +
    # scale_fill_viridis_c(#label = percent, 
      #drop = FALSE
      # na.value = 'gray50') +
    theme(panel.spacing = unit(-0.2, 'cm'),
          strip.text.y = element_text(angle = -90),
          legend.title = element_text(size = 10)) +
    labs(fill = 'Change in\nspawners\nper Km',
         title = str_replace(s, '\\.', ' '))
  
  
  p2 <- ggplot() +
    theme_void() +
    geom_sf(data = sub_shp,
            fill = 'gray50',
            color = 'black',
            lwd = 0.01) +
    geom_sf(data = shp_plt,
            aes(fill = diff_prcnt), # * 1e3),
            color = 'black',
            lwd = 0.01) +
    facet_wrap(~species2, nrow = 1) +
    scale_fill_gradient2(low = 'white',
                         high = muted(shp_plt$color %>% unique),
                         mid = shp_plt$color %>% unique,
                         midpoint = .125,
                         limits = c(0, 0.25),
                         labels = label_percent(accuracy = 1L)) +
    theme(panel.spacing = unit(-0.2, 'cm'),
          plot.margin = unit(c(-3.25,0,0,0), "cm"),
          strip.background = element_blank(),
          strip.text.x = element_blank(),
          legend.title = element_text(size = 10)) +
    labs(fill = 'Basinwide\nspawners')
         #title = str_replace(s, '\\.', ' '))

  plist <- list(p1, p2)
  
  p_grid <- cowplot::plot_grid(plotlist = plist,
                               ncol = 1,
                               align = 'v',
                               rel_heights = c(1.3, 1, 1, 1))
  
  
  folder_name <- 'Figs_Section1_stacked'
  
  if (dir.exists(folder_name) == F) {dir.create(folder_name)}
  
  cowplot::save_plot(file.path(folder_name,paste0('3_',s,'.tiff')),
                     p_grid,
                     base_height = 5,
                     base_width = 7.5,
                     dpi = 500,
                     compression = "lzw")
  
  
}

plt_scenarios <- sub_plot %>%
  filter(str_detect(scenario, 'ASRP|Historical|FP', negate = TRUE)) %>%
  pull(scenario) %>%
  unique



lapply(plt_scenarios[1], plot_stacked)

```


### Percent diff per km

```{r}

plot_prcnt_per_km_change <- function(s) {
  shp_plt <- sub_plot %>% filter(scenario == s)

  p <- ggplot() +
    theme_void() +
    geom_sf(data = sub_shp,
            fill = 'gray50',
            color = 'black',
            lwd = 0.01) +
    geom_sf(data = shp_plt,
            aes(fill = diff_prcnt_km2), # * 1e3),
            color = 'black',
            lwd = 0.01) +
    facet_wrap(~species2) +
    scale_fill_gradient2(low = 'white',
                         high = muted(shp_plt$color %>% unique),
                         mid = shp_plt$color %>% unique,
                         midpoint = .0005,
                         limits = c(0, 0.001),
                         labels = label_percent()) +
    theme(panel.spacing = unit(-0.2, 'cm'),
          strip.text.x = element_text(margin = margin(0,0,0.05,0, "cm"))) +
    labs(fill = 'Percent change\nin basinwide\nspawners\nper 100 km',
         title = str_replace(s, '\\.', ' '))

  folder_name <- 'Figs_Section1_prcnt_diff_per_km'

  if (dir.exists(folder_name) == F) {dir.create(folder_name)}

  ggsave(file.path(folder_name,paste0('4_',s,'.tiff')),
         p,
         height = 4,
         width = 6.5,
         dpi = 500,
         compression = "lzw")

}


plt_scenarios <- sub_plot %>%
  filter(str_detect(scenario, 'ASRP|Historical|FP', negate = TRUE)) %>%
  pull(scenario) %>%
  unique



lapply(plt_scenarios, plot_prcnt_per_km_change)
```


# Section 2

6 panel figures

## Spawner change by species

```{r}



# sub_plot_binned <- sub_plot %>%
#   ungroup %>%
#   mutate(diff_per_km_bin = cut(diff_per_km, c(-Inf, 0:5, 10, 20, Inf)))
  # mutate(diff_per_km_bin = case_when(
  #   species == 'coho'           ~ cut(diff_per_km, c(-Inf, 0, 5, 10, 20, 50, Inf)),
  #   species == 'spring_chinook' ~ cut(diff_per_km, c(-Inf, 0, 1, 2,  5,  10, Inf)),
  #   species == 'fall_chinook'   ~ cut(diff_per_km, c(-Inf, 0, 3, 10, 20, 50, Inf)),
  #   species == 'steelhead'      ~ cut(diff_per_km, c(-Inf, 0, 2, 10, 20, 50, Inf))
  # ))
  #filter(diff_per_km > 0)

plot_spawners_per_km_diag <- function(s) {

  if (s == 'Coho') {upper_lim <- 15}
  if (s == 'Fall Chinook') {upper_lim <- 5 }
  if (s == 'Spring Chinook') {upper_lim <- 1 }
  if (s == 'Steelhead') {upper_lim <- 3 }

  
  
  shp_plt <- sub_plot %>% 
    filter(species2 == s,
           str_detect(scenario, 'ASRP|Historical|FP', negate = TRUE)) %>%
    mutate(#diff_per_km_bin = cut(diff_per_km, c(-Inf, cutpoints, Inf)),
           scenario = str_replace(scenario, '\\.', ' '),
           diff_per_km2 = ifelse(diff_per_km > upper_lim,
                               upper_lim,
                               ifelse(diff_per_km <= 0,
                                      0,
                                      diff_per_km)))
    
  
  p <- ggplot() +
    theme_void() +
    geom_sf(data = sub_shp,
            fill = 'gray50',
            color = 'black',
            lwd = 0.01) +
    geom_sf(data = shp_plt, 
            aes(fill = diff_per_km2), # * 1e3),
            color = 'black',
            lwd = 0.01) +
    facet_wrap(~scenario) +
    scale_fill_viridis_c(na.value = 'gray50',
                         breaks = seq(0, upper_lim, length.out = 3),
                         labels = c(seq(0, upper_lim, length.out = 3)[-3], 
                                    paste0('>', upper_lim) )
                         #drop = FALSE,
                         #na.translate = FALSE
                         ) +
    theme(strip.text.y = element_text(angle = -90)) +
    labs(fill = 'Change in\nspawners\nper km',
         title = s)
  
  folder_name <- 'Figs_Section2_spawner_change'
  
  if (dir.exists(folder_name) == F) {dir.create(folder_name)}
  
  ggsave(file.path(folder_name,paste0(s,'_bin.tiff')), 
         p,
         height = 4,
         width = 6.5,
         dpi = 500,
         compression = "lzw")
}

plt_spp <- sub_plot$species2 %>% unique


lapply(plt_spp, plot_spawners_per_km_diag)

```

## Pn change by species

```{r}


plot_pn <- function(s) {

  shp_plt <- sub_plot %>% 
    filter(species2 == s,
           str_detect(scenario, 'ASRP|Historical|FP', negate = TRUE)) %>%
    mutate(diff_pn2 = ifelse(diff_pn > 3,
                             3,
                             diff_pn),
           scenario = str_replace(scenario, '\\.', ' '))
  
  p <- ggplot() +
    theme_void() +
    geom_sf(data = sub_shp,
            fill = 'gray50',
            color = 'black',
            lwd = 0.01) +
    geom_sf(data = shp_plt, 
            aes(fill = diff_pn2), # * 1e3),
            color = 'black',
            lwd = 0.01) +
    facet_wrap(~scenario) +
    scale_fill_viridis_c(na.value = 'gray50',
                         breaks = 0:3,
                         labels = c(0:2, '>3'),
                         #drop = FALSE,
                         #na.translate = FALSE
                         ) +
    theme(strip.text.y = element_text(angle = -90)) +
    labs(fill = expression(P[n]~ change),
         title = s)
  
  folder_name <- 'Figs_Section2_Pn_change'
  
  if (dir.exists(folder_name) == F) {dir.create(folder_name)}
  
  ggsave(file.path(folder_name,paste0(s,'.tiff')), 
         p,
         height = 4,
         width = 6.5,
         dpi = 500,
         compression = "lzw")
}

plt_spp <- sub_plot$species2 %>% unique


lapply(plt_spp, plot_pn)
```



# Section 3

## 8 panel ASRP scenarios

ASRP 1-3 and Historical 2040 and 2080

```{r}

plot_spawners_per_km_asrp <- function(s) {

  if (s == 'Coho') {upper_lim <- 15}
  if (s == 'Fall Chinook') {upper_lim <- 5 }
  if (s == 'Spring Chinook') {upper_lim <- 1 }
  if (s == 'Steelhead') {upper_lim <- 3 }

  
  
  shp_plt <- sub_plot %>% 
    select(-Shape) %>%
    filter(species2 == s,
           str_detect(scenario, 'ASRP.s')) %>% #|Historical.2
    mutate(climate = sub('.*\\.', '', scenario),
           scenario = str_extract(scenario,'.*\\.') %>%
             str_replace('\\.', ' '),
           diff_per_km2 = ifelse(diff_per_km > upper_lim,
                               upper_lim,
                               diff_per_km))
                               # ifelse(diff_per_km <= 0,
                               #        0,
                               #        diff_per_km)))
    

  p <- ggplot() +
    theme_void() +
    geom_sf(data = sub_shp,
            fill = 'gray50',
            color = 'black',
            lwd = 0.01) +
    geom_sf(data = shp_plt, 
            aes(fill = diff), # * 1e3),
            color = 'black',
            lwd = 0.01) +
    facet_grid(climate~scenario, 
               switch = 'y') +
    scale_fill_gradient2(low = 'red',
                         mid = 'white',
                         high = 'blue',
                         midpoint = 0,
                         label = label_comma()) +
    theme(strip.text = element_text(size = 10),
          strip.text.y = element_text(angle = -90)) +
    labs(fill = 'Change in\nspawners', #'Change in\nspawners\nper Km'
         title = s)
  
  folder_name <- 'Figs_Section3_spawner_change'
  
  if (dir.exists(folder_name) == F) {dir.create(folder_name)}
  
  ggsave(file.path(folder_name,paste0(s,'.tiff')), 
         p,
         height = 4,
         width = 6.5,
         dpi = 500,
         compression = "lzw")
}

plt_spp <- sub_plot$species2 %>% unique


lapply(plt_spp, plot_spawners_per_km_asrp)

```


## natural potential - ASRP scenarios

ASRP 3 and Historical 2040 and 2080

```{r}

plot_spawners_per_km_asrp <- function(s) {

  if (s == 'Coho') {upper_lim <- 15}
  if (s == 'Fall Chinook') {upper_lim <- 5 }
  if (s == 'Spring Chinook') {upper_lim <- 1 }
  if (s == 'Steelhead') {upper_lim <- 3 }

  
  
  shp_plt <- sub_plot %>% 
    filter(species2 == s,
           str_detect(scenario, 'ASRP.s'),
           str_detect(scenario, 'scenario.3')) %>% #|Historical.2
    mutate(climate = sub('.*\\.', '', scenario),
           scenario = str_extract(scenario,'.*\\.') %>%
             str_replace('\\.', ' '),
           diff_per_km2 = ifelse(diff_per_km > upper_lim,
                               upper_lim,
                               diff_per_km))
                               # ifelse(diff_per_km <= 0,
                               #        0,
                               #        diff_per_km)))
    

  p <- ggplot() +
    theme_void() +
    geom_sf(data = sub_shp,
            fill = 'gray50',
            color = 'black',
            lwd = 0.01) +
    geom_sf(data = shp_plt, 
            aes(fill = diff_asrp), # * 1e3),
            color = 'black',
            lwd = 0.01) +
    facet_grid(climate~scenario, 
               switch = 'y') +
    scale_fill_gradient2(low = 'red',
                         mid = 'white',
                         high = 'blue',
                         midpoint = 0,
                         label = label_comma()) +
    theme(strip.text = element_text(size = 10),
          strip.text.y = element_text(angle = -90)) +
    labs(fill = 'Change in\nspawners', #'Change in\nspawners\nper Km'
         title = s)
  
  folder_name <- 'Figs_Section3_spawner_change_from_nat_potential'
  
  if (dir.exists(folder_name) == F) {dir.create(folder_name)}
  
  ggsave(file.path(folder_name,paste0(s,'.tiff')), 
         p,
         height = 4,
         width = 6.5,
         dpi = 500,
         compression = "lzw")
}

plt_spp <- sub_plot$species2 %>% unique


lapply(plt_spp, plot_spawners_per_km_asrp)

```

## natural potential - ASRP scenarios per km

ASRP 3 and Historical 2040 and 2080 per km

```{r}

plot_spawners_per_km_asrp <- function(s) {

  if (s == 'Coho') {upper_lim <- 15}
  if (s == 'Fall Chinook') {upper_lim <- 5 }
  if (s == 'Spring Chinook') {upper_lim <- 1 }
  if (s == 'Steelhead') {upper_lim <- 3 }

  
  
  shp_plt <- sub_plot %>% 
    filter(species2 == s,
           str_detect(scenario, 'ASRP.s'),
           str_detect(scenario, 'scenario.3')) %>% #|Historical.2
    mutate(climate = sub('.*\\.', '', scenario),
           scenario = str_extract(scenario,'.*\\.') %>%
             str_replace('\\.', ' '),
           diff_per_km2 = ifelse(diff_per_km > upper_lim,
                               upper_lim,
                               diff_per_km))
                               # ifelse(diff_per_km <= 0,
                               #        0,
                               #        diff_per_km)))
    

  p <- ggplot() +
    theme_void() +
    geom_sf(data = sub_shp,
            fill = 'gray50',
            color = 'black',
            lwd = 0.01) +
    geom_sf(data = shp_plt, 
            aes(fill = diff_per_km_asrp), # * 1e3),
            color = 'black',
            lwd = 0.01) +
    facet_grid(climate~scenario, 
               switch = 'y', ) +
    scale_fill_gradient2(low = 'red',
                         mid = 'white',
                         high = 'blue',
                         midpoint = 0,
                         label = label_comma()) +
    theme(strip.text = element_text(size = 10),
          strip.text.y = element_text(angle = -90)) +
    labs(fill = 'Change in\nspawners\nper Km',
         title = s)
  
  folder_name <- 'Figs_Section3_spawner_change_from_nat_potential_per_km'
  
  if (dir.exists(folder_name) == F) {dir.create(folder_name)}
  
  ggsave(file.path(folder_name,paste0(s,'.tiff')), 
         p,
         height = 4,
         width = 6.5,
         dpi = 500,
         compression = "lzw")
}

plt_spp <- sub_plot$species2 %>% unique


lapply(plt_spp, plot_spawners_per_km_asrp)

```

# Delete below here -- testing

```{r}
sub_df %>%
  group_by(species) %>%
  summarize(max = max(diff_per_km, na.rm = T),
            mean = mean(diff_per_km, na.rm = T),
            median = median(diff_per_km, na.rm = T))


x <- sub_plot %>%
  filter(str_detect(scenario, 'ASRP.s|Historical.2')) %>%
  mutate(climate = sub('.*\\.', '', scenario))

x$scenario %>%
  unique %>%
  str_extract('.*\\.')
  
```

```{r}
sub_plot %>%
  st_drop_geometry() %>%
  #filter(Subbasin %in% c('Mainstem: Lower Chehalis 7', 'Satsop River')) %>% 
 #filter(species == 'steelhead') %>%
  View
```

```{r}
'../hab/Inputs/spatial_model_outputs/flowline_20200512.csv' %>%
  read.csv %>%
  filter(str_detect(noaa_sub, 'Unnamed')) %>%
  select(Reach, noaa_sub) %>%
  distinct %>%
  arrange(noaa_sub) %>%
  write.csv('EDT_reach_names.csv')
```


