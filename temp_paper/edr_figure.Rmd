---
title: "Untitled"
author: "Caleb Fogel"
date: "11/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

library(tidyverse)
library(sf)
library(scales)
library(gridExtra)
```
# Read in data

First step is to read in the data. **There are various versions of the model, so ensure that this document is pointing at the version you want.** Spawner results from model runs can be found on the shared drive at the address below, or regenerated by running the correct version of the model.

The default behavior is to 


Location of spatial model outputs: `//nwcfile/FE/watershed/Chehalis/Data/10-Habitat data layers/SpatialModel_Archive/`
Location of spawner outputs: `//nwcfile/FE/watershed/Chehalis/Data/11-Model Outputs/`

Note: as we are working from home, I am working from a version of GIS files on my local machine. 

```{r}

# Habitat scenario and LCM results
# results <- '//nwcfile/FE/watershed/Chehalis/Data/11-Model Outputs/V14_pr226_dev/'
results <- 'outputs'



# Spatial data
# Data is either local or on shared drive

if (dir.exists("C:/01_Projects/Chehalis/Spatial_Model/spatial_model_gitlab")) {
  
  # Colin's local files
  
  gdb_in <- 'C:/01_Projects/Chehalis/Spatial_Model/spatial_model_gitlab/Inputs.gdb'
  gdb_out <- 'C:/01_Projects/Chehalis/Spatial_Model/spatial_model_gitlab/Outputs.gdb'
  
} else {
  # Access files on the network
  gdb_in <- '//nwcfile/FE/watershed/Chehalis/Data/10-Habitat data layers/SpatialModel_Archive/20190604/Inputs.gdb'
  gdb_out <- '//nwcfile/FE/watershed/Chehalis/Data/10-Habitat data layers/SpatialModel_Archive/20190604/Outputs.gdb'
  
}



# Subbasin names and EDRs
Subbasin_names <- read.csv('lcm/data/Subbasin_names.csv') %>%
  mutate(EcoRegion = ifelse(str_detect(Subbasin, 'Estuary'),'Estuary', as.character(EcoRegion)))

# Plot colors and labels
plot.params <- read.csv('lcm/data/scenarios.csv') %>% 
  select(scenario, scenario.label, color) %>%
  mutate_if(is.factor, as.character) %>%
  rowid_to_column()
```


Read in the necessary GIS layers
```{r echo = TRUE, message=FALSE}

# Flowline (which has spawning distributions)
fl <- st_read(gdb_out, 'flowline')

# Subbasin layer
sub <- st_read(gdb_in, 'NOAA_subbasins_w_fp') %>% st_geometry()
```

## Figure 4 - Restore one EDR at a time

First gather up the data
```{r}
# List all results by EDR files
edr_paths <- list.files(results,
                        recursive = TRUE,
                        pattern = 'abundance_by_EDR',
                        full.names = TRUE)

sub_paths <- list.files(results,
                        recursive = TRUE,
                        pattern = 'abundance_by_subbasin.csv',
                        full.names = TRUE)

# Create list of species to attach to each file
spp <- edr_paths %>%
  dirname %>%
  dirname %>%
  basename()


edr_df <- edr_paths %>%
sub_df <- 
  map_dfr(.id = 'species', read.csv) %>%
  select(-X) %>%
  mutate(species = spp[as.numeric(species)]) %>%
  group_by(species, EcoRegion) %>%
  mutate(baseline = basinwide_spawners[scenario == 'ASRP.cc.only.2080'],
         diff = basinwide_spawners - baseline,
         diff_perc = diff/baseline,
         diff_bin = cut(diff, 
                        c(-Inf, 200, 5000, 10000, Inf),
                        c('< 200', '200 - 5,000', '5,000 - 10,000', '> 10,000'))) %>%
  ungroup %>%
  mutate(presence = case_when( # create NAs for spring chinook basins
    str_detect(species, 'spring') & 
      str_detect(EcoRegion, 'Mainstem|Cascade|Willapa', negate = TRUE) ~ 'no fish'),
    diff_prcnt2 = ifelse(!is.na(presence), NA,
                         ifelse(is.na(diff_perc), 0, 
                                ifelse(diff_perc > 1, 1, diff_perc))),
    diff2 = ifelse(!is.na(presence), NA,
                   ifelse(is.na(diff), 0, diff)),
    diff_prcnt2_bin = cut(diff_prcnt2, 
                        c(-Inf, 0.05, .1, .25, .50, Inf),
                        c('< 5%', '5 - 10%', '10-25%', '25 - 50%', '> 50%')),
    species2 = case_when(
           species == 'coho'  ~ 'Coho',
           species == 'fall_chinook'  ~ 'Fall Chinook',
           species == 'spring_chinook'   ~ 'Spring Chinook',
           species == 'steelhead' ~ 'Steelhead',
           species == 'chum'  ~ 'Chum')
  )

```



```{r}
# Union subbasins into EDRs
sub_edr <- st_read(dsn = gdb_in, layer = 'NOAA_subbasins_w_fp') %>%
  rename(Subbasin_num = noaa_sub_num) %>%
  left_join(Subbasin_names) %>%
  group_by(EcoRegion) %>%
  summarize(Area_km2 = sum(Area_km2)) %>%
  ungroup
```

Join the spawner data to the new EDR layer. Also join the `plot.param` data
```{r}
sub_plot_diag <- sub_edr %>%
  left_join(edr_df) %>%
  filter(str_detect(EcoRegion, 'Estuary|Upper Sk', negate = TRUE),
         str_detect(scenario, 'rip|fp.temp'),
         str_detect(scenario, '2040', negate = TRUE),
         species != 'chum') %>%
  left_join(plot.params) %>%
  mutate(scenario = case_when(
    scenario == 'ASRP.rip.and.climate.2080' ~ 'Riparian',
    scenario == 'ASRP.fp.temp.2080' ~ 'Floodplain',
    scenario == 'ASRP.rip.and.flp.2080' ~ 'Combined',
    TRUE ~ 'NA'
  ))

```

Figure 4 with the 'standard' results of change in EDR as a percent of the EDR under current conditions. This matches the text of the draft paper. 

```{r}

edr_df2 <- edr_df %>%
  filter(str_detect(EcoRegion, 'Estuary|Upper Sk', negate = TRUE),
         str_detect(scenario, 'rip|fp.temp'),
         str_detect(scenario, '2040', negate = TRUE),
         species != 'chum') %>%
  mutate(diff_perc2 = ifelse(diff_perc > 1, 1, 
                             ifelse(diff_perc < 0, 0, 
                                    diff_perc)),
         diff_perc_bin = cut(diff_perc,
                             c(-Inf, seq(.1,.9, .1), Inf)))

sub_plot <- sub_edr %>% #st_drop_geometry()
  #left_join(one_edr_df) %>%
  left_join(edr_df2) %>%
  filter(!is.na(scenario),
         !is.na(species2)) %>%
  mutate(scenario = case_when(
    scenario == 'LR' ~ "Large River",
    TRUE ~ str_replace(scenario, '\\.', ' ') %>% tools::toTitleCase(.)
  ))

sub_plot_diag$scenario <- factor(sub_plot_diag$scenario, levels = c('Riparian', 'Floodplain', 'Combined'))
sub_plot_diag2 <- sub_plot_diag %>%
  mutate(scenario = recode(scenario, 'Riparian' = ' ', 'Floodplain' = '  ', 'Combined' = '   '))


p_coho <- ggplot() +
  theme_void() +
  geom_sf(data = sub_plot_diag2 %>% 
            filter(species2 == 'Coho'),
          aes(fill = diff2),
          color = 'black',
          lwd = 0.01) +
  geom_sf(data = filter(sub_edr, str_detect(EcoRegion, 'Estuary|Upper Sk')),
          fill = 'gray50',
          color = 'black',
          lwd = 0.01) +
  facet_grid(species2~scenario, switch = 'y') +
  scale_fill_viridis_c(
      label = scales::label_comma()) +
    labs(fill = '                  ') +
    guides(fill = guide_colorbar(barwidth = .75,
                                 barheight = 4,
                                 label.theme = element_text(size = 8))) +
    theme(
      # strip.text.x = element_blank(),
      strip.text.x = element_text(margin = margin(0,0,.1,0, "cm")),
          plot.tag.position = c(0.02, .9))

p_spring <- ggplot() +
  theme_void() +
  geom_sf(data = sub_plot_diag %>% 
            filter(species2 == 'Spring Chinook'),
          aes(fill = diff2),
          color = 'black',
          lwd = 0.01) +
  geom_sf(data = filter(sub_edr, str_detect(EcoRegion, 'Estuary|Upper Sk')),
          fill = 'gray50',
          color = 'black',
          lwd = 0.01) +
  facet_grid(species2~scenario, switch = 'y') +
  scale_fill_viridis_c(
      label = scales::label_comma()) +
    labs(fill = 'Change in\nspawners') +
    guides(fill = guide_colorbar(barwidth = .75,
                                 barheight = 4,
                                 label.theme = element_text(size = 8))) +
    theme(
      # strip.text.x = element_blank(),
      strip.text.x = element_text(margin = margin(0,0,.1,0, "cm")),
          plot.tag.position = c(0.02, .9))

p_fall <- ggplot() +
  theme_void() +
  geom_sf(data = sub_plot_diag2 %>% 
            filter(species2 == 'Fall Chinook'),
          aes(fill = diff2),
          color = 'black',
          lwd = 0.01) +
  geom_sf(data = filter(sub_edr, str_detect(EcoRegion, 'Estuary|Upper Sk')),
          fill = 'gray50',
          color = 'black',
          lwd = 0.01) +
  facet_grid(species2~scenario, switch = 'y') +
  scale_fill_viridis_c(
      label = scales::label_comma()) +
    labs(fill = '                  ') +
    guides(fill = guide_colorbar(barwidth = .75,
                                 barheight = 4,
                                 label.theme = element_text(size = 8))) +
    theme(
      # strip.text.x = element_blank(),
      strip.text.x = element_text(margin = margin(0,0,.1,0, "cm")),
          plot.tag.position = c(0.02, .9))

p_steel <- ggplot() +
  theme_void() +
  geom_sf(data = sub_plot_diag2 %>% 
            filter(species2 == 'Steelhead'),
          aes(fill = diff2),
          color = 'black',
          lwd = 0.01) +
  geom_sf(data = filter(sub_edr, str_detect(EcoRegion, 'Estuary|Upper Sk')),
          fill = 'gray50',
          color = 'black',
          lwd = 0.01) +
  facet_grid(species2~scenario, switch = 'y') + 
  scale_fill_viridis_c(
      label = scales::label_comma()) +
    labs(fill = '                  ') +
    guides(fill = guide_colorbar(barwidth = .75,
                                 barheight = 4,
                                 label.theme = element_text(size = 8))) +
    theme(
      # strip.text.x = element_blank(),
      strip.text.x = element_text(margin = margin(0,0,.1,0, "cm")),
          plot.tag.position = c(0.02, .9))

edr_plt <- cowplot::plot_grid(p1 = p_spring,
                              p2 = p_coho,
                              p3 = p_steel,
                              p4 = p_fall,
                              nrow = 4,
                              align = 'v')

ggsave('temp_paper/edr_figure.tiff',
      edr_plt,
       width = 6,
       height = 8,
       dpi = 500,
       compression = "lzw")
```